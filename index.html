<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Effective Hours Calculator</title>
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #333;
      --heading-color: #2c3e50;
      --card-bg: #fff;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
      --card-highlight: #e8f4f8;
      --input-border: #ddd;
      --input-focus: #3498db;
      --input-bg: #fff;
      --input-text: #333;
      --stat-value-color: #3498db;
      --stat-label-color: #7f8c8d;
      --clock-color: #2c3e50;
      --primary-btn: #3498db;
      --primary-btn-hover: #2980b9;
      --delete-btn: #e74c3c;
      --delete-btn-hover: #c0392b;
      --add-btn: #2ecc71;
      --add-btn-hover: #27ae60;
      --warning-btn: #f39c12;
      --warning-btn-hover: #e67e22;
      --theme-toggle-bg: #ddd;
      --theme-toggle-circle: #fff;
      --break-color: #f39c12;
      --ongoing-color: #2ecc71;
      --completed-color: #95a5a6;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #f0f0f0;
      --heading-color: #e0e0e0;
      --card-bg: #2a2a2a;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.3);
      --card-highlight: #2c3e50;
      --input-border: #555;
      --input-focus: #5dade2;
      --input-bg: #333;
      --input-text: #f0f0f0;
      --stat-value-color: #5dade2;
      --stat-label-color: #bdc3c7;
      --clock-color: #e0e0e0;
      --primary-btn: #2980b9;
      --primary-btn-hover: #3498db;
      --delete-btn: #c0392b;
      --delete-btn-hover: #e74c3c;
      --add-btn: #27ae60;
      --add-btn-hover: #2ecc71;
      --warning-btn: #e67e22;
      --warning-btn-hover: #f39c12;
      --theme-toggle-bg: #555;
      --theme-toggle-circle: #f0f0f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    h1, h2 {
      color: var(--heading-color);
      margin-bottom: 20px;
    }
    
    .card {
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 24px;
      margin-bottom: 24px;
      background-color: var(--card-bg);
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .summary-card {
      background: linear-gradient(135deg, var(--card-highlight) 0%, var(--card-bg) 100%);
      border: 1px solid var(--input-border);
    }
    
    .punches-container {
      margin-bottom: 20px;
    }
    
    .punch-row {
      display: flex;
      margin-bottom: 12px;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--card-bg);
      border: 1px solid var(--input-border);
      transition: all 0.2s ease;
    }

    .punch-row:hover {
      border-color: var(--input-focus);
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
    }

    .punch-row.ongoing {
      border-color: var(--ongoing-color);
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, var(--card-bg) 100%);
    }

    .punch-row.completed {
      border-color: var(--completed-color);
    }
    
    .time-input {
      padding: 10px 12px;
      border: 2px solid var(--input-border);
      border-radius: 6px;
      margin-right: 12px;
      width: 130px;
      background-color: var(--input-bg);
      color: var(--input-text);
      transition: all 0.2s ease;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .time-input:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .time-input.invalid {
      border-color: var(--delete-btn);
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }
    
    button {
      background-color: var(--primary-btn);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      background-color: var(--primary-btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    button:active {
      transform: translateY(0);
    }
    
    .delete-btn {
      background-color: var(--delete-btn);
    }
    
    .delete-btn:hover {
      background-color: var(--delete-btn-hover);
    }
    
    .add-btn {
      background-color: var(--add-btn);
    }
    
    .add-btn:hover {
      background-color: var(--add-btn-hover);
    }

    .warning-btn {
      background-color: var(--warning-btn);
    }

    .warning-btn:hover {
      background-color: var(--warning-btn-hover);
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      background-color: var(--card-bg);
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid var(--input-border);
    }

    .stat-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--stat-value-color);
      margin: 8px 0;
      font-family: 'Courier New', monospace;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--stat-label-color);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    
    .header-container {
      margin-bottom: 30px;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .top-clock-btn {
      font-size: 16px;
      padding: 12px 24px;
      background-color: var(--add-btn);
      font-weight: 600;
      border-radius: 8px;
    }
    
    .top-clock-btn:hover {
      background-color: var(--add-btn-hover);
    }
    
    #clock {
      font-size: 24px;
      color: var(--clock-color);
      margin-bottom: 20px;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      text-align: center;
      padding: 16px;
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--input-border);
    }
    
    .button-group {
      margin-top: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .duration-display {
      min-width: 100px;
      text-align: center;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: var(--stat-value-color);
      background-color: rgba(52, 152, 219, 0.1);
      padding: 8px 12px;
      border-radius: 4px;
      margin-right: 12px;
    }

    .duration-display.ongoing {
      color: var(--ongoing-color);
      background-color: rgba(46, 204, 113, 0.1);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .break-indicator {
      color: var(--break-color);
      font-size: 12px;
      margin-left: 8px;
      font-weight: 500;
    }

    /* Theme Toggle Switch */
    .theme-switch-container {
      display: flex;
      align-items: center;
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .theme-switch {
      display: inline-block;
      height: 28px;
      position: relative;
      width: 56px;
    }

    .theme-switch input {
      display: none;
    }

    .slider {
      background-color: var(--theme-toggle-bg);
      bottom: 0;
      cursor: pointer;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      background-color: var(--theme-toggle-circle);
      bottom: 4px;
      content: "";
      height: 20px;
      left: 4px;
      position: absolute;
      transition: .4s;
      width: 20px;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input:checked + .slider:before {
      transform: translateX(28px);
    }

    .theme-icons {
      display: flex;
      justify-content: space-between;
      width: 56px;
      position: absolute;
      top: 6px;
      left: 0;
      padding: 0 8px;
      box-sizing: border-box;
      font-size: 14px;
      color: var(--text-color);
    }

    .export-section {
      margin-top: 20px;
      padding: 16px;
      background-color: rgba(52, 152, 219, 0.05);
      border-radius: 8px;
      border: 1px solid var(--input-border);
    }

    .export-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--heading-color);
    }

    .date-picker {
      padding: 8px 12px;
      border: 2px solid var(--input-border);
      border-radius: 6px;
      margin-right: 12px;
      background-color: var(--input-bg);
      color: var(--input-text);
      transition: all 0.2s ease;
    }

    .date-picker:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .validation-message {
      font-size: 12px;
      color: var(--delete-btn);
      margin-top: 4px;
      display: none;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background-color: var(--add-btn);
    }

    .notification.error {
      background-color: var(--delete-btn);
    }

    .notification.warning {
      background-color: var(--warning-btn);
    }
    
    @media (max-width: 600px) {
      body {
        padding: 16px;
      }

      .punch-row {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .time-input {
        margin-right: 0;
        width: 100%;
      }

      .duration-display {
        margin-right: 0;
        margin-bottom: 8px;
      }

      .stats {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .theme-switch-container {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 20px;
        justify-content: flex-end;
      }
      
      .header-top {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      
      .top-clock-btn {
        width: 100%;
      }

      .button-group {
        flex-direction: column;
      }

      .button-group button {
        margin-right: 0;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="theme-switch-container">
    <label class="theme-switch">
      <input type="checkbox" id="theme-toggle">
      <span class="slider"></span>
      <div class="theme-icons">
        <span>☀️</span>
        <span>🌙</span>
      </div>
    </label>
  </div>

  <div class="header-container">
    <div class="header-top">
      <h1>Enhanced Effective Hours Calculator</h1>
      <button id="clock-in-out" class="top-clock-btn">Clock In</button>
    </div>
    <div id="clock"></div>
  </div>
  
  <div class="card summary-card">
    <h2>Today's Summary</h2>
    <div class="stats">
      <div class="stat-item">
        <div class="stat-label">Effective Hours</div>
        <div id="effective-hours" class="stat-value">0h 0m</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Clock Time</div>
        <div id="clock-time" class="stat-value">0h 0m</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Efficiency Rate</div>
        <div id="efficiency-rate" class="stat-value">0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Break Time</div>
        <div id="break-time" class="stat-value">0h 0m</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Time Since Last Out</div>
        <div id="time-since-last-out" class="stat-value">0h 0m</div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <h2>Time Entries</h2>
    <div id="punches-container" class="punches-container">
      <!-- Punch entries will be generated here -->
    </div>
    
    <div class="button-group">
      <button id="add-punch" class="add-btn">Add Time Entry</button>
      <button id="quick-break" class="warning-btn">Start Break</button>
      <button id="save-data">Save Data</button>
      <button id="load-data">Load Data</button>
      <button id="reset-data">Reset</button>
    </div>

    <div class="export-section">
      <h3>Data Export</h3>
      <input type="date" id="export-date" class="date-picker" />
      <button id="export-csv">Export CSV</button>
      <button id="export-json">Export JSON</button>
    </div>
  </div>

  <script>
    // Enhanced theme management
    function setTheme(isDark) {
      document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
      localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('darkMode');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'enabled' || (savedTheme === null && prefersDark);
      
      setTheme(isDark);
      document.getElementById('theme-toggle').checked = isDark;
    }

    // Enhanced notification system
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Default punch data with date storage
    let punches = [];
    let currentDate = new Date().toDateString();

    // Load data for current date
    loadDataFromStorage();

    function parseTime(str) {
      if (!str) return new Date();
      
      // Handle both HH:MM:SS and HH:MM formats
      const timeParts = str.split(":").map(Number);
      const [h, m, s] = [timeParts[0] || 0, timeParts[1] || 0, timeParts[2] || 0];
      
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s);
    }

    function formatTime(date) {
      if (!date) return "";
      const h = date.getHours().toString().padStart(2, "0");
      const m = date.getMinutes().toString().padStart(2, "0");
      const s = date.getSeconds().toString().padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    function formatDuration(ms) {
      if (ms < 0) return "0h 0m";
      const hrs = Math.floor(ms / (1000 * 60 * 60));
      const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      return `${hrs}h ${mins}m`;
    }

    function validateTimeInput(timeStr) {
      if (!timeStr) return true;
      const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/;
      return timeRegex.test(timeStr);
    }

    function calculateBreakTime() {
      let totalBreakMs = 0;
      
      for (let i = 0; i < punches.length - 1; i++) {
        const currentPunch = punches[i];
        const nextPunch = punches[i + 1];
        
        if (currentPunch[1] && nextPunch[0]) {
          const breakStart = parseTime(currentPunch[1]);
          const breakEnd = parseTime(nextPunch[0]);
          totalBreakMs += breakEnd - breakStart;
        }
      }
      
      return totalBreakMs;
    }

    function calculateTotals() {
      let totalEffectiveMs = 0;
      let firstInTime = null;
      let lastOutTime = null;
      let lastPunchWithOut = null;

      punches.forEach(([inTime, outTime], index) => {
        if (inTime && validateTimeInput(inTime)) {
          const start = parseTime(inTime);
          const end = outTime && validateTimeInput(outTime) ? parseTime(outTime) : new Date();
          
          if (index === 0 || !firstInTime) {
            firstInTime = start;
          }
          
          if (outTime && validateTimeInput(outTime)) {
            lastOutTime = parseTime(outTime);
            lastPunchWithOut = [inTime, outTime];
          } else {
            lastOutTime = new Date();
          }
          
          totalEffectiveMs += Math.max(0, end - start);
        }
      });

      // Calculate total clock time
      let totalClockMs = 0;
      if (firstInTime && lastOutTime) {
        totalClockMs = Math.max(0, lastOutTime - firstInTime);
      }

      // Calculate break time
      const totalBreakMs = calculateBreakTime();

      // Calculate efficiency rate
      let efficiencyRate = 0;
      if (totalClockMs > 0) {
        efficiencyRate = (totalEffectiveMs / totalClockMs) * 100;
      }

      // Calculate time since last clock out
      let timeSinceLastOutMs = 0;
      if (lastPunchWithOut) {
        const lastOut = parseTime(lastPunchWithOut[1]);
        const now = new Date();
        timeSinceLastOutMs = Math.max(0, now - lastOut);
        
        const isCurrentlyClocked = punches.some(punch => punch[0] && !punch[1]);
        if (isCurrentlyClocked) {
          timeSinceLastOutMs = 0;
        }
      }

      // Update display
      document.getElementById("effective-hours").innerText = formatDuration(totalEffectiveMs);
      document.getElementById("clock-time").innerText = formatDuration(totalClockMs);
      document.getElementById("efficiency-rate").innerText = efficiencyRate.toFixed(1) + "%";
      document.getElementById("break-time").innerText = formatDuration(totalBreakMs);
      document.getElementById("time-since-last-out").innerText = timeSinceLastOutMs > 0 ? 
        formatDuration(timeSinceLastOutMs) : "N/A";
    }

    function renderPunches() {
      const container = document.getElementById("punches-container");
      container.innerHTML = "";

      punches.forEach((punch, index) => {
        const row = document.createElement("div");
        row.className = "punch-row";
        
        // Add status classes
        if (punch[0] && !punch[1]) {
          row.classList.add("ongoing");
        } else if (punch[0] && punch[1]) {
          row.classList.add("completed");
        }
        
        // In time input
        const inInput = document.createElement("input");
        inInput.type = "text";
        inInput.className = "time-input";
        inInput.value = punch[0] || "";
        inInput.placeholder = "In (HH:MM:SS)";
        inInput.dataset.index = index;
        inInput.dataset.type = "in";
        inInput.addEventListener("change", updatePunchTime);
        inInput.addEventListener("blur", validateInput);
        
        // Out time input
        const outInput = document.createElement("input");
        outInput.type = "text";
        outInput.className = "time-input";
        outInput.value = punch[1] || "";
        outInput.placeholder = "Out (HH:MM:SS)";
        outInput.dataset.index = index;
        outInput.dataset.type = "out";
        outInput.addEventListener("change", updatePunchTime);
        outInput.addEventListener("blur", validateInput);

        // Duration display
        const duration = document.createElement("div");
        duration.className = "duration-display";
        
        if (punch[0] && punch[1]) {
          const start = parseTime(punch[0]);
          const end = parseTime(punch[1]);
          const durationMs = Math.max(0, end - start);
          duration.innerText = formatDuration(durationMs);
        } else if (punch[0]) {
          duration.innerText = "Ongoing";
          duration.classList.add("ongoing");
        } else {
          duration.innerText = "0h 0m";
        }

        // Break indicator
        const breakIndicator = document.createElement("span");
        if (index > 0 && punches[index - 1][1] && punch[0]) {
          const prevOut = parseTime(punches[index - 1][1]);
          const currentIn = parseTime(punch[0]);
          const breakDuration = currentIn - prevOut;
          if (breakDuration > 0) {
            breakIndicator.className = "break-indicator";
            breakIndicator.innerText = `Break: ${formatDuration(breakDuration)}`;
          }
        }

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.innerText = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.dataset.index = index;
        deleteBtn.addEventListener("click", deletePunch);

        row.appendChild(inInput);
        row.appendChild(outInput);
        row.appendChild(duration);
        if (breakIndicator.innerText) row.appendChild(breakIndicator);
        row.appendChild(deleteBtn);
        container.appendChild(row);
      });
    }

    function validateInput(event) {
      const input = event.target;
      const isValid = validateTimeInput(input.value);
      
      if (!isValid && input.value) {
        input.classList.add("invalid");
        showNotification("Invalid time format. Use HH:MM or HH:MM:SS", "error");
      } else {
        input.classList.remove("invalid");
      }
    }

    function updatePunchTime(event) {
      const index = parseInt(event.target.dataset.index);
      const type = event.target.dataset.type;
      const value = event.target.value;
      
      if (!validateTimeInput(value) && value) {
        showNotification("Invalid time format", "error");
        return;
      }
      
      if (type === "in") {
        punches[index][0] = value;
      } else {
        punches[index][1] = value;
      }
      
      saveDataToStorage();
      renderPunches();
      calculateTotals();
    }

    function addPunch() {
      punches.push(["", ""]);
      saveDataToStorage();
      renderPunches();
      showNotification("New time entry added", "success");
    }

    function startQuickBreak() {
      // Find ongoing punch and clock out
      const ongoingPunchIndex = punches.findIndex(punch => punch[0] && !punch[1]);
      
      if (ongoingPunchIndex >= 0) {
        const now = new Date();
        punches[ongoingPunchIndex][1] = formatTime(now);
        saveDataToStorage();
        renderPunches();
        calculateTotals();
        updateClockInOutButton();
        showNotification("Break started - clocked out", "warning");
      } else {
        showNotification("No active time entry to end", "error");
      }
    }

    function deletePunch(event) {
      const index = parseInt(event.target.dataset.index);
      if (confirm("Are you sure you want to delete this time entry?")) {
        punches.splice(index, 1);
        saveDataToStorage();
        renderPunches();
        calculateTotals();
        showNotification("Time entry deleted", "success");
      }
    }

    function updateClock() {
      const now = new Date();
      const timeStr = formatTime(now);
      const dateStr = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      document.getElementById("clock").innerHTML = 
        `<div>${dateStr}</div><div>${timeStr}</div>`;
      calculateTotals();
    }

    function handleClockInOut() {
      const topButton = document.getElementById("clock-in-out");
      const ongoingPunchIndex = punches.findIndex(punch => punch[0] && !punch[1]);
      
      if (ongoingPunchIndex >= 0) {
        // Clock out
        const now = new Date();
        punches[ongoingPunchIndex][1] = formatTime(now);
        topButton.innerText = "Clock In";
        topButton.style.backgroundColor = "var(--add-btn)";
        showNotification("Clocked out successfully", "success");
      } else {
        // Clock in
        const now = new Date();
        punches.push([formatTime(now), ""]);
        topButton.innerText = "Clock Out";
        topButton.style.backgroundColor = "var(--delete-btn)";
        showNotification("Clocked in successfully", "success");
      }
      
      saveDataToStorage();
      renderPunches();
      calculateTotals();
    }

    function updateClockInOutButton() {
      const topButton = document.getElementById("clock-in-out");
      const ongoingPunch = punches.some(punch => punch[0] && !punch[1]);
      
      if (ongoingPunch) {
        topButton.innerText = "Clock Out";
        topButton.style.backgroundColor = "var(--delete-btn)";
      } else {
        topButton.innerText = "Clock In";
        topButton.style.backgroundColor = "var(--add-btn)";
      }
    }

    function saveDataToStorage() {
      const data = {
        punches: punches,
        date: currentDate
      };
      localStorage.setItem("effectiveHoursPunches", JSON.stringify(data));
      
      // Also save historical data
      const historicalKey = `effectiveHours_${currentDate}`;
      localStorage.setItem(historicalKey, JSON.stringify(punches));
    }

    function loadDataFromStorage() {
      const savedData = localStorage.getItem("effectiveHoursPunches");
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          if (data.date === currentDate) {
            punches = data.punches || [];
          } else {
            // Load data for current date if different
            const historicalKey = `effectiveHours_${currentDate}`;
            const historicalData = localStorage.getItem(historicalKey);
            if (historicalData) {
              punches = JSON.parse(historicalData);
            } else {
              punches = [];
            }
          }
        } catch (e) {
          console.error("Error loading data:", e);
          punches = [];
        }
      }
    }

    function resetData() {
      if (confirm("Are you sure you want to reset all time entries for today?")) {
        punches = [];
        saveDataToStorage();
        renderPunches();
        calculateTotals();
        updateClockInOutButton();
        showNotification("Data reset successfully", "success");
      }
    }

    function exportToCSV() {
      const selectedDate = document.getElementById("export-date").value;
      let dataToExport = punches;
      
      if (selectedDate) {
        const dateKey = `effectiveHours_${new Date(selectedDate).toDateString()}`;
        const historicalData = localStorage.getItem(dateKey);
        if (historicalData) {
          dataToExport = JSON.parse(historicalData);
        } else {
          showNotification("No data found for selected date", "warning");
          return;
        }
      }
      
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Date,Clock In,Clock Out,Duration\n"
        + dataToExport.map(([inTime, outTime]) => {
          const duration = inTime && outTime ? 
            formatDuration(parseTime(outTime) - parseTime(inTime)) : 
            (inTime ? "Ongoing" : "");
          return `${selectedDate || new Date().toLocaleDateString()},${inTime || ""},${outTime || ""},${duration}`;
        }).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `time_entries_${selectedDate || new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification("CSV exported successfully", "success");
    }

    function exportToJSON() {
      const selectedDate = document.getElementById("export-date").value;
      let dataToExport = punches;
      
      if (selectedDate) {
        const dateKey = `effectiveHours_${new Date(selectedDate).toDateString()}`;
        const historicalData = localStorage.getItem(dateKey);
        if (historicalData) {
          dataToExport = JSON.parse(historicalData);
        } else {
          showNotification("No data found for selected date", "warning");
          return;
        }
      }
      
      const exportData = {
        date: selectedDate || new Date().toISOString().split('T')[0],
        entries: dataToExport,
        exported: new Date().toISOString()
      };
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
      const link = document.createElement("a");
      link.setAttribute("href", dataStr);
      link.setAttribute("download", `time_entries_${selectedDate || new Date().toISOString().split('T')[0]}.json`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification("JSON exported successfully", "success");
    }

    // Initialize the application
    function initApp() {
      renderPunches();
      calculateTotals();
      updateClockInOutButton();
      updateClock();
      initTheme();
      
      // Set today's date as default for export
      document.getElementById("export-date").value = new Date().toISOString().split('T')[0];
    }

    // Setup event listeners
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("add-punch").addEventListener("click", addPunch);
      document.getElementById("quick-break").addEventListener("click", startQuickBreak);
      document.getElementById("clock-in-out").addEventListener("click", handleClockInOut);
      document.getElementById("save-data").addEventListener("click", function() {
        saveDataToStorage();
        showNotification("Data saved successfully", "success");
      });
      document.getElementById("load-data").addEventListener("click", function() {
        loadDataFromStorage();
        renderPunches();
        calculateTotals();
        updateClockInOutButton();
        showNotification("Data loaded successfully", "success");
      });
      document.getElementById("reset-data").addEventListener("click", resetData);
      document.getElementById("export-csv").addEventListener("click", exportToCSV);
      document.getElementById("export-json").addEventListener("click", exportToJSON);
      document.getElementById("theme-toggle").addEventListener("change", function(e) {
        setTheme(e.target.checked);
        showNotification(`Switched to ${e.target.checked ? 'dark' : 'light'} theme`, "success");
      });

      // Listen for system dark mode changes
      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          if (localStorage.getItem('darkMode') === null) {
            setTheme(e.matches);
            document.getElementById('theme-toggle').checked = e.matches;
          }
        });
      }

      // Initialize the app
      initApp();
    });

    // Update the clock and calculations every second
    setInterval(updateClock, 1000);

  </script>
</body>
</html>
